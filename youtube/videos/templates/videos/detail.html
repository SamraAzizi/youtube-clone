{% extends "base.html" %}

{% load static %}


{% block title %}
{{ video.title }} - Youtube Clone
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/videos.css' %}">
    <link rel="stylesheet" href="{% static 'css/videoplayer.css' %}">
{% endblock %}

{% block content %}

<div class="video-player-container">
    <div class="video-player">
        <video id="video-player" controls preload="none" poster="{{ video.display_thumbnail }}">
            <div id="video-error" class="video-error" style="display: none;">
                <span class="error-icon">‚ö°</span>
                <p>Video Unavailable</p>
                <small>The video file could not be loaded</small>
            </div>

        </video>


    </div>

    <div class="video-details">
        <h1>{{ video.title }}</h1>


        <div class="video-stats">
            <span class="video-stats-left">{{ video.views }} views || {{ video.created_at|date: "M d, Y"}}</span>

            <div class="video-actions">
                <button class="vote-btn {% if user_vote == 1 %}active{% endif %}" data-vote="like" onclick="vote({{ vote.id }}, 'like')">
                    üëç<span id="like-count">{{ video.like }}</span>
                </button>

                <button class="vote-btn {% if user_vote == -1 %}active{% endif %}" data-vote="dislike" onclick="vote({{ vote.id }}, 'dislike')">
                    üëé<span id="dislike-count">{{ video.dislike }}</span>
                </button>


            </div>
        </div>

        <div class="video-channel">
            <div class="channel-avater">{{ video.user.username|slice:":1"|upper }}</div>
            <a href="{% url 'videos:channel' video.user.username %}" class = "channel-name">{{ video.user.username }}</a>

            </div>

            {% if video.description %}
            <p class="video-description">{{ video.description }}</p>

            {% endif %}

            {% if request.user == video.user %}
            <div class="video-owner-actions">
                <button class="delete-btn" type="button" onClick="deleteVideo({{ video.id }})">Delete</button>

            </div>
            {% endif %}

        </div>

    </div>
</div>

{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>

        const videoPlayer = document.getElementById('video-player');
        const videoError = document.getElementById('video-error');
        const streamingUrl = "{{ video.streaming_url }}";
        const fallbackUrl = "{{ video.fallback_url }}";

        if (Hls.isSupported()) {
            const hls = new Hls({
                startLevel : -1,
                capLevelToPlayerSize : true,

            })
            hls.loadSource(streamingUrl);
            hls.attachMedia(videoPlayer);
            hls.on(Hls.Events.Error, (event, data) =>{
                if (data.fatal){
                    videoPlayer.src = fallbackUrl;
                }
            })
        }
        else if (videoPlayer.canPlayType("application/vnd.apple.mpegurl")) {
            videoPlayer.src = streamingUrl;
        }
        else {
            videoPlayer.src = fallbackUrl;
        }

        videoPlayer.addEventListener('error', (e) => {
            videoPlayer.style.display = 'none';
            videoError.style.display = 'flex';
        });

const csrf = '{{ csrf_token }}';
function deleteVideo(videoId) {
    if (!confirm("Are you sure you want to delete this video?")) return;
    fetch('/${videoId}delete', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrf,
        },
    }).then(r => r.json())
    .then(data =>{
        if(data.success) window.location.href = '{% url "videos:list" %}';
        else alert(data.error || "failed to delete video");
    })
    .catch(() => alert("failed to delete video"));
}

function vote(voteId, voteType) {
    {% if not user.is_authenticated %}
    window.location.href = '{% url "accounts:login" %}'
    return;

    fetch(`/${videoId}/vote/`,{
        method: "POST",
        headers: {
            'X-CSRFToken': csrf,
            'Content-Type': 'application/json',
        },
        body: `vote=${voteType}`,
    }).then(r => r.json())
    .then(data =>{
        document.getElementById('like-count').innerText = data.likes;
        document.getElementById('dislike-count').innerText = data.dislikes;
        document.querySelectorAll('.vote-btn').forEach(btn => btn.classList.remove('active'));
        if(data.user_vote === 1) document.querySelector('.vote-btn[data-vote="like"]').classList.add('active');
        else if(data.user_vote === -1) document.querySelector('.vote-btn[data-vote="dislike"]').classList.add('active');

        });
    }
    


    </script>


    
{% endblock %}